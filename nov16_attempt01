$(document).ready(function() {
    // Function to generate a unique session ID
    function generateSessionId() {
        return 'session-' + new Date().getTime() + '-' + Math.floor(Math.random() * 10000);
    }

    // Generate a unique session ID for this page load
    var sessionId = generateSessionId();

    // Hide the original submit button
    $('button[type="submit"]').hide();

    // Create and insert a new button for triggering the API request
    var newButton = $('<button type="button" class="button is-primary is-pulled-right">Send Chat</button>');

    // Create the chat window content as a jQuery object
    var chatWindowSection = $(
        `<section id="chat-window" class="box form-control">
            <!-- Placeholder content -->
            <div class="chat-message chat-prompt placeholder" style="align-self: flex-start;">
                <p>What is Tray.ai?</p>
            </div>
            <div class="chat-message chat-response placeholder" style="align-self: flex-end;">
                <p>Tray.ai is a General Automation Platform that automates complex processes using a visual workflow builder.</p>
            </div>
        </section>`
    );

    // Create the helper prompts section
    var helperPromptsSection = $(
        `<div id="helper-prompts">
            <button class="helper-prompt" data-message="What is Tray.ai?">What is Tray.ai?</button>
            <button class="helper-prompt" data-message="How can I use AI for my job?">How can I use AI for my job?</button>
            <button class="helper-prompt" data-message="What is iPaaS?">What is iPaaS?</button>
        </div>`
    );

    // Find the form element and insert the chat window section and helper prompts above it
    $('form').before(chatWindowSection).before(helperPromptsSection);

    // Append the new button to the form
    $('form').append(newButton);

    // Function to send a message to the API
    function sendMessage(userMessage) {
        var chatWindow = $('#chat-window');
        if (chatWindow.length === 0) {
            console.error('Chat window not found');
            return;
        }

        // Remove placeholders if they exist
        chatWindow.find('.placeholder').remove();

        // Display the user's message in the chat window immediately
        chatWindow.append(
            `<div class="chat-message chat-prompt" style="align-self: flex-start;">
                <p>${userMessage}</p>
            </div>`
        );

        // Scroll to the bottom of the chat window
        chatWindow.scrollTop(chatWindow[0].scrollHeight);

        // Wait for a short moment before showing the "Thinking..." message
        setTimeout(function() {
            // Display the "Thinking..." message with a fade-in effect
            chatWindow.append(
                `<div class="chat-message chat-response thinking" style="display:none; align-self: flex-end;">
                    <p>Thinking...</p>
                </div>`
            );
            chatWindow.find('.thinking').fadeIn('slow');

            // Scroll to the bottom of the chat window
            chatWindow.scrollTop(chatWindow[0].scrollHeight);

            // Change button text to "Thinking..." and disable it
            newButton.text('Thinking...').prop('disabled', true);

            // Prepare the request payload
            var payload = {
                message: userMessage,
                sessionId: sessionId,
                timestamp: new Date().toISOString(),
                // Add any additional data you want to send
                metadata: {
                    client: 'web',
                    version: '1.0'
                }
            };

            // Your API endpoint
            var apiUrl = 'https://bf4df1b3-fae0-40b3-a656-ee20a7a97eeb-api.trayapp.io/ai-agent'; // Replace with your actual API endpoint

            // Make the API call
            $.ajax({
                url: apiUrl,
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(payload),
                headers: {
                    // Add any required headers
                    'Authorization': 'Bearer {$.auth.access_token}', // Replace with your API key
                    'Accept': 'application/json'
                },
              	body: {
                  'prompt': payload.message ,
                  'session_id': payload.sessionId ,
                  'calling_interface' : 'markdown'
                success: function(response) {
                    console.log('Response:', response);

                    // Assuming the API returns a response with a 'result' field
                    var chatContent = response.result;

                    if (!chatContent) {
                        console.error('No chat content found in response');
                        return;
                    }

                    // Remove the "Thinking..." message
                    chatWindow.find('.thinking').remove();

                    // Append the response content to the chat window
                    chatWindow.append(
                        `<div class="chat-message chat-response" style="align-self: flex-end;">
                            ${chatContent}
                        </div>`
                    );

                    // Scroll to the bottom of the chat window
                    chatWindow.scrollTop(chatWindow[0].scrollHeight);

                    // Clear the input field
                    $('textarea[name="Chat"]').val('');

                    // Reset the button text and re-enable it
                    newButton.text('Send Chat').prop('disabled', false);
                },
                error: function(xhr, status, error) {
                    console.error('Error calling API:', error);
                    console.error('Status:', status);
                    console.error('Response:', xhr.responseText);

                    // Remove the "Thinking..." message
                    chatWindow.find('.thinking').remove();

                    // Add error message to chat window
                    chatWindow.append(
                        `<div class="chat-message chat-error" style="align-self: flex-end;">
                            <p>Sorry, there was an error processing your request. Please try again.</p>
                        </div>`
                    );

                    // Reset the button text and re-enable it
                    newButton.text('Send Chat').prop('disabled', false);
                }
            });
        }, 500);
    }

    // Add click event to the new button
    newButton.on('click', function() {
        var userMessage = $('textarea[name="Chat"]').val();
        if (userMessage.trim()) {
            sendMessage(userMessage);
        }
    });

    // Add click event to the helper prompts
    $(document).on('click', '.helper-prompt', function() {
        var message = $(this).data('message');
        sendMessage(message);
    });

    // Handle sending messages on Enter key press
    $(document).on('keypress', 'textarea[name="Chat"]', function(e) {
        if (e.which === 13 && !e.shiftKey) {
            e.preventDefault();
            var userMessage = $(this).val();
            if (userMessage.trim()) {
                sendMessage(userMessage);
            }
        }
    });
});
